# Отчёт: Проверка режима строительства / защиты

**Дата:** 2025-12-29  
**Цель:** Проверка наличия активных механизмов защиты ДО PHP на уровне nginx и Cloudflare

---

## Шаг 1. Nginx (сервер)

### Проверенные механизмы:

#### ❌ `auth_basic`
**Статус:** ОТСУТСТВУЕТ  
**Применение:** Нет базовой HTTP-аутентификации в nginx конфигурации

#### ❌ `allow/deny` правила
**Статус:** ОТСУТСТВУЕТ (кроме стандартной защиты скрытых файлов)  
**Применение:** 
- Единственное правило: `location ~ /\. { deny all; }` (защита скрытых файлов)
- Нет IP-based ограничений для `/shape-sinbad/`

#### ❌ `geo` блоки
**Статус:** ОТСУТСТВУЕТ  
**Применение:** Нет географических ограничений

#### ❌ `if ($maintenance)` условия
**Статус:** ОТСУТСТВУЕТ  
**Применение:** Нет режима обслуживания на уровне nginx

#### ✅ Специфичные `location` блоки
**Статус:** ЧАСТИЧНО  
**Применение:**
- Есть отдельные блоки для `/assets/`, `/auth/`, `/kneeboard`, `/forum/`
- **НЕТ** отдельного блока для `/shape-sinbad/`
- `/shape-sinbad/` обрабатывается через общий `location / { try_files $uri $uri/ /index.php?$args; }`

### Текущая конфигурация `/shape-sinbad/`:

```nginx
# Главная логика
location / {
    try_files $uri $uri/ /index.php?$args;
}

# PHP-FPM
location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}
```

**Итог:** Запросы к `/shape-sinbad/` **пропускаются до PHP** без дополнительных проверок на уровне nginx.

---

## Шаг 2. Cloudflare

### Проверенные механизмы:

#### ❓ Cloudflare Access
**Статус:** НЕ ОБНАРУЖЕНО В КОДЕ  
**Примечание:** Нельзя проверить через код репозитория. Требуется проверка в панели Cloudflare.

#### ❓ WAF Rules
**Статус:** НЕ ОБНАРУЖЕНО В КОДЕ  
**Примечание:** Настройки WAF находятся в панели Cloudflare, не в коде.

#### ❓ Under Attack Mode
**Статус:** НЕ ОБНАРУЖЕНО В КОДЕ  
**Примечание:** Включается в панели Cloudflare, не отражается в коде.

#### ❓ IP Allowlist
**Статус:** НЕ ОБНАРУЖЕНО В КОДЕ  
**Примечание:** Настройки IP-фильтрации находятся в панели Cloudflare.

#### ✅ Cloudflare IP detection (в коде XenForo)
**Статус:** ОБНАРУЖЕНО  
**Расположение:** `forum/src/XF/Http/Request.php`  
**Применение:** Используется для определения реального IP клиента через заголовок `HTTP_CF_CONNECTING_IP`  
**Примечание:** Это НЕ механизм защиты, а вспомогательная логика для корректной работы IP-based функций.

---

## Шаг 3. Итог

### Где включён режим защиты:

| Уровень | Механизм | Статус | Применение к `/shape-sinbad/` |
|---------|----------|--------|-------------------------------|
| **Nginx** | `auth_basic` | ❌ Нет | - |
| **Nginx** | `allow/deny` | ❌ Нет | - |
| **Nginx** | `geo` блоки | ❌ Нет | - |
| **Nginx** | `if ($maintenance)` | ❌ Нет | - |
| **Nginx** | Отдельный `location` | ❌ Нет | Обрабатывается через `location /` |
| **Cloudflare** | Access / WAF / Under Attack | ❓ Неизвестно | Требуется проверка в панели |
| **PHP** | Gate авторизации | ✅ Есть | Проверка в `shape-sinbad/index.php` |

### Применяется ли к `/shape-sinbad/`:

**На уровне nginx:** ❌ НЕТ  
- Нет специальных правил для `/shape-sinbad/`
- Запросы обрабатываются через общий `location /`
- Нет блокировок до PHP

**На уровне Cloudflare:** ❓ НЕИЗВЕСТНО  
- Требуется проверка в панели Cloudflare
- Нельзя определить через код репозитория

### Пропускает ли запросы до PHP:

✅ **ДА**  
- Nginx **пропускает** все запросы к `/shape-sinbad/` до PHP-FPM
- Единственная защита — PHP gate в `shape-sinbad/index.php`
- Нет блокировок на уровне веб-сервера

---

## Рекомендации

1. ✅ **PHP gate работает корректно** — единственная защита Shape
2. ❓ **Проверить Cloudflare настройки** — в панели Cloudflare Dashboard
3. ⚠️ **Рассмотреть добавление nginx-level защиты** (опционально):
   - IP whitelist через `allow/deny`
   - `auth_basic` для дополнительной защиты
   - Отдельный `location` блок для `/shape-sinbad/` с проверками

---

**Вывод:** На уровне nginx нет механизмов защиты для `/shape-sinbad/`. Все запросы пропускаются до PHP, где работает gate авторизации. Статус Cloudflare требует проверки в панели управления.



