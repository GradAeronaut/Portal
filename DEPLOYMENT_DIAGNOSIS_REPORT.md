# Отчёт: Диагностика деплоя (Read-Only)

**Дата:** 2025-12-29  
**Цель:** Определить источник деплоя и причину отсутствия gate кода на сервере

---

## Шаг 1. Результаты диагностики

> **ВНИМАНИЕ:** Заполнить после выполнения `diagnose_deployment_readonly.sh` на сервере

### 1.1. Git Remotes

```
[ЗАПОЛНИТЬ: Результат команды `git remote -v`]
```

**Определённый основной remote:** `[origin/server/другой]`

---

### 1.2. Активная ветка

```
[ЗАПОЛНИТЬ: Результат команды `git branch --show-current`]
```

---

### 1.3. Текущий HEAD

```
SHA: [ЗАПОЛНИТЬ]
Коммит: [ЗАПОЛНИТЬ: результат `git log --oneline -1`]
```

**Соответствие коммиту f42182b:** `[ДА/НЕТ]`

---

### 1.4. Состояние относительно remote

**Последний коммит в `${MAIN_REMOTE}/main`:**
```
[ЗАПОЛНИТЬ: SHA и описание]
```

**Соответствие локального HEAD и `${MAIN_REMOTE}/main`:** `[СОВПАДАЕТ/НЕ СОВПАДАЕТ]`

**Коммиты в remote, которых нет локально:**
```
[ЗАПОЛНИТЬ: список коммитов или "нет"]
```

**Последний коммит в `origin/main` (если доступен):**
```
[ЗАПОЛНИТЬ: SHA и описание]
```

---

### 1.5. Проверка gate кода в файле

**Файл `shape-sinbad/index.php`:**

- [ ] Файл найден
- [ ] Файл НЕ найден

**Содержимое:**

- [ ] Содержит `GATE_TEST` ✅
- [ ] Содержит `GATE_OK` ⚠️ (старая версия)
- [ ] Содержит только `session_start` ⚠️ (нет gate кода)
- [ ] Не содержит gate код ❌

**Первые строки файла (если не содержит gate код):**
```
[ЗАПОЛНИТЬ: первые 20 строк]
```

---

### 1.6. Автоматический деплой

**Cron задачи:**
- [ ] Найдены задачи с git/deploy/pull
- [ ] Не найдены

**Список найденных cron задач:**
```
[ЗАПОЛНИТЬ: если найдены]
```

**Systemd timers:**
- [ ] Найдены timers для sinbad/portal/deploy
- [ ] Не найдены

**Список найденных timers:**
```
[ЗАПОЛНИТЬ: если найдены]
```

**Webhook/Autopull скрипты:**
- [ ] Найдены скрипты
- [ ] Не найдены

**Список найденных скриптов:**
```
[ЗАПОЛНИТЬ: если найдены]
```

---

## Шаг 2. Анализ и выводы

### 2.1. Источник истины (что реально деплоится)

```
[ЗАПОЛНИТЬ: 
- Какой remote используется для деплоя?
- Какая ветка является канонической?
- Откуда берётся код на сервере?]
```

**Ответ:**

---

### 2.2. Почему сервер остаётся на f42182b

```
[ЗАПОЛНИТЬ: 
- HEAD совпадает с f42182b? (ДА/НЕТ)
- Есть ли auto-pull/webhook, который откатывает код?
- Код не синхронизирован с remote?
- Другая причина?]
```

**Ответ:**

**Подтверждение:**
- [ ] HEAD = f42182b
- [ ] Найден auto-pull/webhook, который откатывает код
- [ ] Код не синхронизирован с remote
- [ ] Другая причина: `[описание]`

---

### 2.3. Подтверждение, что код с gate не попадает на сервер

```
[ЗАПОЛНИТЬ: 
- Файл содержит gate код? (ДА/НЕТ)
- HEAD находится на коммите с gate кодом? (ДА/НЕТ)
- Коммиты с gate кодом есть в remote, но не на сервере? (ДА/НЕТ)]
```

**Ответ:**

**Подтверждение:**
- [ ] Файл НЕ содержит gate код
- [ ] HEAD находится на коммите ДО добавления gate (f42182b или раньше)
- [ ] Коммиты с gate кодом есть в `origin/main`, но не на сервере
- [ ] Коммиты с gate кодом есть в `${MAIN_REMOTE}/main`, но не на сервере
- [ ] Другая причина: `[описание]`

---

## Шаг 3. Рекомендации (без изменений)

> **ВНИМАНИЕ:** Только рекомендации, НЕ выполнять

### Что нужно сделать для исправления:

1. **[Рекомендация 1]**
   ```
   [Описание что нужно сделать]
   ```

2. **[Рекомендация 2]**
   ```
   [Описание что нужно сделать]
   ```

3. **[Рекомендация 3]**
   ```
   [Описание что нужно сделать]
   ```

---

## Приложение: Коммиты с gate кодом

**Коммит f42182b (ДО gate):**
- `f42182b` - SSO tech debt cleanup (tokens TTL, test user removal)

**Коммиты с gate кодом (после f42182b):**
- `0ea2bc6` - Add authentication gate to Shape and remove hardcoded user data
- `fb1db7c` - Add strict authentication gate with die for testing
- `250683c` - Add GATE_TEST with 401 status for production verification
- `fd374ff` - Add server deployment source check script and instructions
- `9c25b65` - Update deployment check script with remote detection
- `9e191a3` - Add critical info about server remote types and GitHub sync requirement
- `a54a4e5` - Add automatic deployment fix script and step-by-step diagnosis guide

**Текущий HEAD (локально):** `a54a4e5` или новее



