# Настройка отправки email подтверждения

## Шаг 1. Настройка SMTP Migadu

1. Скопируйте файл конфигурации:
   ```bash
   cp config/smtp.php.example config/smtp.php
   ```

2. Отредактируйте `config/smtp.php` и заполните ваши данные Migadu:
   ```php
   return [
       'host' => 'smtp.migadu.com',
       'port' => 587,  // или 465 для SSL
       'encryption' => 'tls',  // или 'ssl' для порта 465
       'username' => 'your-email@yourdomain.com',
       'password' => 'your-password',
       'from_email' => 'noreply@yourdomain.com',
       'from_name' => 'Sinbad Portal',
   ];
   ```

3. **ВАЖНО:** Не коммитьте `config/smtp.php` в git! Файл уже должен быть в `.gitignore`.

## Шаг 2. Проверка работы

### Тестирование регистрации:

1. Зарегистрируйте нового пользователя через `/app/register.php`
2. Проверьте почту - должно прийти письмо с ссылкой подтверждения
3. Перейдите по ссылке в письме
4. После подтверждения вы должны быть автоматически авторизованы и перенаправлены на `/auth/login/index.html`

### Структура файлов:

```
auth/email/
  ├── verify_email.txt      # Текстовый шаблон письма
  └── verify_email.html     # HTML шаблон письма (опционально)

config/
  ├── smtp.php.example      # Пример конфигурации
  └── smtp.php              # Ваша конфигурация (создать вручную)

php/
  └── email_helpers.php      # Функции отправки email

app/
  ├── register.php           # Модифицирован: генерирует токен и отправляет письмо
  └── verify.php             # Обрабатывает токен и авторизует пользователя
```

## Шаг 3. Что происходит при регистрации

1. Пользователь регистрируется через `/app/register.php`
2. Генерируется `verification_token` (64 символа hex)
3. Токен сохраняется в БД в поле `users.verification_token`
4. Отправляется письмо с ссылкой: `https://gradaeronaut.com/app/verify.php?token=...`
5. Пользователь **НЕ** авторизуется автоматически (в отличие от старой версии)

## Шаг 4. Что происходит при подтверждении

1. Пользователь переходит по ссылке из письма
2. `/app/verify.php` находит пользователя по токену
3. Обновляет:
   - `email_verified = 1`
   - `status = 'active'`
   - `verification_token = NULL`
4. Создается сессия и устанавливается cookie
5. Редирект на `/auth/login/index.html`

## Шаг 5. Проверка после подтверждения

После подтверждения email пользователь может:
- Войти через `/app/login.php`
- Получить доступ к Shape
- Получить доступ к KNEEBOARD

## Отладка

Если письма не приходят:

1. Проверьте логи PHP:
   ```bash
   tail -f /var/log/php/error_log | grep -i "smtp\|email"
   ```

2. Проверьте конфигурацию SMTP в `config/smtp.php`

3. Проверьте, что порт 587 (или 465) не заблокирован firewall

4. Проверьте учетные данные Migadu

5. Убедитесь, что функция `send_email_smtp()` вызывается (добавьте логирование)

## Безопасность

- ✅ `config/smtp.php` не должен быть в git
- ✅ Пароли хранятся в конфиге (защищенном файлом системы)
- ✅ Токены верификации одноразовые (удаляются после использования)
- ✅ Токены имеют достаточную энтропию (64 символа hex = 256 бит)



