CANONICAL — любое расхождение считается ошибкой архитектуры

# SSO Technical Spec

## Table: sso_tokens

- **id** — внутренний технический идентификатор записи. Не используется в логике SSO, только для БД.
- **token** — одноразовый криптографический ключ, служит доказательством права входа из Portal в Forum. Обязан быть уникальным.
- **public_id** — канонический внешний идентификатор пользователя Sinbad Portal. Единственная допустимая связь с пользователем.
- **expires_at** — момент, после которого токен недействителен при любых условиях. Проверяется всегда, даже если токен не использован.
- **used_at** — фиксирует факт использования токена. `NULL` — токен ещё не применялся. `NOT NULL` — повторное использование запрещено.
- **created_at** — момент генерации токена в Portal. Используется для аудита и отладки.
- **ip_created** — IP-адрес, с которого был выдан токен. Используется для базовой безопасности и расследований.
- **user_agent** — User-Agent клиента, инициировавшего выпуск токена. Используется для диагностики и защиты.

## Правила

- токен одноразовый;
- истечение времени приоритетнее всего;
- повторное использование = отказ;
- отсутствие любого обязательного поля = ошибка SSO;
- изменение структуры таблицы допускается только через обновление этого документа.

## Hard Coupling Policy

- Portal — единственный хозяин жизненного цикла.
- XenForo — подчинённый модуль (iframe).
- Любой сбой Portal = полный reset Portal + XenForo.
- Logout всегда совместный и мгновенный.
- При падении XenForo и живом Portal — никаких автодействий, только индикатор отказа («красный крест»).
- Перезагрузка Portal = единственный способ восстановления.

## SSO Forward Algorithm (Canonical)

- `sso/forward` вызывается **только при отсутствии сессии Portal**.
- Вход в `sso/forward` без токена считается ошибкой.
- Алгоритм:
  1. Получить SSO-токен из запроса.
  2. Проверить токен: отсутствует / истёк / уже использован → отказ.
  3. Валиден → логин пользователя в XenForo.
  4. Пометить токен использованным.
  5. Redirect в целевую точку.
- Сценарии с существующей XF-сессией **архитектурно исключены** и не обрабатываются.

