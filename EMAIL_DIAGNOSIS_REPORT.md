# Диагностика отправки email при регистрации

## Шаг 1. Проверка кода отправки

### Файл: `/app/register.php`

**Результат проверки:**

❌ **ОТСУТСТВУЕТ отправка email**
- Нет вызова `mail()`
- Нет вызова SMTP-функций
- Нет подключения SMTP-библиотек (PHPMailer, SwiftMailer и т.д.)

❌ **ОТСУТСТВУЕТ генерация verification_token**
- В коде регистрации (строки 123-138) создается пользователь БЕЗ `verification_token`
- Поле `verification_token` остается `NULL` в БД
- Пользователь создается с:
  - `email_verified = 0`
  - `status = 'pending'`
  - `verification_token = NULL`

### Структура БД

✅ **Поле существует:**
- Таблица `users` содержит поле `verification_token CHAR(64) DEFAULT NULL` (см. `sinbad-tables.sql:22`)

### Файл верификации: `/app/verify.php`

✅ **Код верификации существует**, но:
- Ожидает `verification_token` в GET-параметре
- Ищет пользователя по `verification_token` в БД
- Но токен никогда не создается при регистрации

### Конфигурация SMTP

❌ **ОТСУТСТВУЕТ конфигурация SMTP:**
- Нет файлов `config/smtp.php`, `config/email.php`, `config/mail.php`
- Нет переменных окружения для SMTP
- Нет настроек в `config/` директории

### Использование mail() или SMTP

❌ **НЕ ИСПОЛЬЗУЕТСЯ:**
- Нет вызовов `mail()` в `/app/register.php`
- Нет SMTP-конфигурации
- Нет email-хелперов в `/php/` директории

**Примечание:** XenForo форум имеет свою систему отправки email (через Symfony Mailer), но она не используется в Portal регистрации.

---

## Шаг 2. Проверка серверной стороны

### Логи PHP (read-only проверка)

⚠️ **Требуется проверка на сервере:**
```bash
# Проверить логи PHP на ошибки отправки
tail -n 100 /var/log/php/error_log | grep -i "mail\|smtp\|email"
```

### SMTP-конфиг на сервере

⚠️ **Требуется проверка на сервере:**
```bash
# Проверить наличие SMTP-конфигурации
find /var/www -name "*smtp*" -o -name "*mail*" -o -name "*email*" 2>/dev/null
# Проверить переменные окружения
env | grep -i "smtp\|mail"
```

### Блокировка исходящей почты

⚠️ **Требуется проверка на сервере:**
```bash
# Проверить firewall правила
iptables -L | grep -i "smtp\|25\|587\|465"
# Проверить настройки PHP mail
php -i | grep -i "sendmail\|smtp"
```

---

## РЕЗУЛЬТАТ ДИАГНОСТИКИ

### Почему письма не уходят:

**1. КОД:**
- ❌ В `/app/register.php` **ОТСУТСТВУЕТ** генерация `verification_token`
- ❌ В `/app/register.php` **ОТСУТСТВУЕТ** отправка email
- ❌ Нет конфигурации SMTP или `mail()`

**2. КОНФИГ:**
- ❌ Нет файла конфигурации SMTP
- ❌ Нет настроек email в `config/` директории

**3. СЕРВЕР:**
- ⚠️ Требуется проверка логов PHP на ошибки
- ⚠️ Требуется проверка наличия SMTP-конфига
- ⚠️ Требуется проверка блокировки исходящей почты

---

## ВЫВОД

**Основная причина:** Код регистрации **НЕ РЕАЛИЗОВАН** для отправки email.

**Что отсутствует:**
1. Генерация `verification_token` при регистрации
2. Сохранение `verification_token` в БД
3. Отправка email с ссылкой верификации
4. Конфигурация SMTP или настройка `mail()`

**Рекомендации:**
1. Добавить генерацию `verification_token` в `/app/register.php`
2. Добавить отправку email (через SMTP или `mail()`)
3. Создать конфигурацию SMTP в `config/smtp.php`
4. Проверить настройки сервера для отправки почты

---

*Отчет создан: автоматическая диагностика кода*
*Дата: $(date)*



